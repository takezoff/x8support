# シーンとシーン遷移

ゲームは特徴が異なる場面（**シーン**）ごとに分けて作成したほうが、作りやすいしコードの見通しも良くなります。また、場面が切り替わることを**シーン遷移**と言います。

以下のコードを見てください。

```
while true do

   -- Title Scene
   x8.cls()
   x8.fnt("TITILE", 40, 40)
   while true do
      if x8.btntrg(4) then break end
      x8.wait()
   end

   x8.wait()

   -- Play Scene
   x8.cls()
   x8.fnt("PLAY", 40, 50)
   while true do
      if x8.btntrg(4) then break end
      x8.wait()
   end

   -- Game Over Scene
   x8.cls()
   x8.fnt("GAME OVER", 40, 60)
   x8.wait(30 * 3)

end
```

これを実行するとこうなります。

![](imgs/tutorial_01/x8_tuto_01_scenes.gif)

これは簡単なシーン遷移です。**このプログラムは終了しません。**`TITLE`シーンで**Aボタン**を押すと`PLAY`シーンに遷移します。`PLAY`シーンで**Aボタン**を押すと`GAME OVER`シーンに遷移します。`GAME OVER`シーンでは**3秒後**に自動で`TITLE`シーンに遷移します。

## 制御構造とインデント

`while`は、プログラムの流れを制御する構造（**制御構造**）を作る文（**制御構文**）です。処理を繰り返す（**ループ**する）する時に使うもので、こんな形をしています。

> `while` 式 `do` ブロック `end`

`while`文を実行した時、式が**真**なら`do`と`end`で囲まれた**ブロック**（一連の文の並び）を実行し、`end`まで来たら`while`に戻ります（ループします）。式が**偽**なら`end`の次に制御を移します（ループを抜けます）。

`true`は**ブーリアン**型という、値が`true`と`false`の2つしか無い型の値です。`true`は真、`false`は偽と解釈されます。

`if`も、条件によって制御を分岐したい時に使う制御構文です。上記の場合はこんな形をしています。

> `if` 式 `then` ブロック `end`

`if`文を実行した時、式が真なら`then`と`end`で囲まれたブロックを実行します。式が偽なら`end`の次に制御を移します。`if`文はもう少し複雑な分岐も出来ますが、今は先に進みます。

`break`文はそれを囲んでいる最も内側のループを抜けて、制御をループブロックの次へ移します。

ブロックは入れ子構造にすることが出来ます。このコードの場合もこんな感じで入れ子構造になっています。

```
whileブロック#1開始

   whileブロック#2開始
      ifブロック#1開始 〜 ifブロック#1終了
   whileブロック#2終了

   whileブロック#3開始
      ifブロック#2開始 〜 ifブロック#2終了
   whileブロック#3終了

whileブロック#1終了
```

ブロックの開始と終了の対応に注意してください。コードがブロックの内側になるたびに行頭の空白を増やして書いているのは、この入れ子構造を視認しやすくするためです。この字下げのことを**インデント**といいます。

Note: インデントはプログラムの実行には関係ありませんが、人間が見てコードの構造を正しく認識するためにはとても重要です。

Hint: インデントには`Tab`キーでの空白入力が便利です。

## フレームループとボタン入力

`TITLE`シーンの部分を見ていきます。

```
   -- Title Scene
   x8.cls()
   x8.fnt("TITILE", 40, 40)
   while true do
      if x8.btntrg(4) then break end
      x8.wait()
   end
```

`x8.cls`は画面をクリアする（0番の色で塗りつぶす）関数です。

`while`ループの条件式が`true`なので、ブロックの実行を永遠に繰り返します（**無限ループ**します）。

`x8.btntrg`は、今回の**フレーム**でボタンの**トリガー**（ボタンの**OFF**から**ON**への変化）が発生したかどうかの情報を返す関数です。`x8.btntrg(4)`と書いた場合、Aボタンのトリガーがあれば`true`を、無ければ`false`を返します。

ボタンとその番号の関係については以下の通りです。

♪ボタンと番頭の対応図

**フレーム**とは、画面の書き換えを含む、マシンの処理全体の1サイクルのことを言います。x8マシンでは通常、1秒あたり30回のフレーム処理が行われます。前回のフレームで押されていなかったボタンが、今回のフレームで押されると、今回のフレームでそのボタンのトリガーが発生します。

`x8.wait`はフレームを待つ（**マシンの処理サイクルを進める**）関数です。待つフレーム数を引数で指定します。フレーム数を省略すると1フレーム（次のフレームまで）待ちます。**`x8.wait`を呼ばないとフレームは進みません。**

Note: x8のプログラミングでは、無限ループ内には必ず`x8.wait`によるフレーム待ちを入れる必要があります。フレーム待ちを入れないとマシン全体の処理サイクルが進まないため、画面表示やパッド入力の更新が行われず、外見上マシンがフリーズしてしまいます。一定時間`x8.wait`が呼ばれないとタイムアウトエラーでプログラムは停止します。

結局この`TITLE`シーンのコードは、以下のような意味になります。

```
-- Title Scene
画面をクリアする
文字で"TITLE"と表示する
無限ループ
   Aボタンが押されたらループを抜ける
   フレーム更新
ループ終端
```

Hint: このように各シーンの作りは通常、フレーム待ちが入った無限ループの形になります。

## シーン遷移の全体を読む

シーン遷移のコードを読む準備が出来ました。結局、コード全体は以下のような意味になります。

```
無限ループ

   -- Title Scene
   画面をクリアする
   文字で"TITLE"と表示する
   無限ループ
      Aボタンが押されたらループを抜ける
      フレーム更新
   ループ終端

   1フレーム待つ

   -- Play Scene
   画面をクリアする
   文字で"PLAY"と表示する
   無限ループ
     Aボタンが押されたらループを抜ける
     フレーム更新
   ループ終端

   -- Game Over Scene
   画面をクリアする
   文字で"GAME OVER"と表示する
   3秒待つ

ループ終端
```

`PLAY`シーンの直前で**1フレーム待つ**のは、フレーム更新せずに`PLAY`シーンのトリガー判定を行うと、`TITLE`シーンを抜けた原因のトリガーを、`PLAY`シーンでも検出してしまうのを防ぐためです。試しにここをコメントアウトすると`PLAY`シーンがスキップされてしまうのがわかります。

最後の`3秒待つ`の**3秒**は、30フレームで1秒なので、`30 * 3`フレームは3秒という意味です。

これでシーンとシーン遷移の説明はおしまいです。次行きましょー！！
