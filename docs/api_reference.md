# APIリファレンス

## はじめに

### カラー番号

x8では色を0〜15のカラー番号で表します。また、16色のカラー番号のセットをパレットと呼びます。

### 描画ステート

x8はビデオ関連の命令に影響を与える、以下の描画ステートを持っています。

- 描画座標オフセット
    - 全ての描画命令は、位置をこのオフセット分ずらして描画します。
- 描画クリップ矩形
    - 全ての描画命令は、この矩形の内側にだけ描画結果を反映します。
- 描画パレット
    - 全ての描画命令は、描画する色をこのパレットで置き換えます。
- 抜き色情報
    - 全ての描画命令は、この情報で抜きになっている色を描画しません。
- デフォルト描画色
    - 色を指定可能な描画命令で、色を指定しなかった場合、この色で描画します。
- フォントスケール
    - フォント描画命令は、このスケールを反映して描画します。
- フォント間隔
    - フォント描画命令は、各々の文字をこの間隔を開けて描画します。
- 画面パレット
    - 描画結果の画面イメージは、最終的にこのパレットで色を置き換えて、表示されます。

### 画面イメージ

全ての描画命令は、画面イメージと呼ばれる領域に描画を行います。描画結果の画面イメージは、画面パレットで色を置き換えらた後、ディスプレイに表示されます。

### チップ・チップ番号・チップ属性

- チップとは、Gfx領域を8x8ピクセルで分割した画像の単位です。
- チップ番号とは、Gfx領域の左上から順（アドレス順）に、チップに振られた番号（0〜255）のことです。
- チップ属性とは、チップに対応する1byteの情報のことで、Gfxエディタでビット毎にエディット出来ます。

### スプライト

x8では、チップを直接描画したものを慣例的にスプライトと呼んでいます。

### マップ

x8では、Map領域に並べられたチップ群を描画したものを慣例的にマップと呼んでいます。

### フォント

x8には、いくつかの組み込みフォントとそのAPIが用意されています。カタカナや特殊文字を含む文字列は、APIなどで扱う前にまず、`x8.enc()`で8bitコードに変換する必要があります。

```
x8.fnt(x8.enc("ｶﾀｶﾅ ﾄｶ ←→↑↓ ﾄｶ ｶﾞ ﾊｲｯﾃｲﾙ ﾓｼﾞﾚﾂ ﾊ enc()ﾃﾞ 8bit ｺｰﾄﾞ ﾆ ﾍﾝｶﾝ ｽﾍﾞｼ"))
str_len = string.len(x8.enc("ｶﾀｶﾅ ﾄｶ ⒶⒷⒸⒹ ﾄｶ ｱｯﾃﾓ stringﾗｲﾌﾞﾗﾘ ﾊ ｿﾉﾏﾏ ﾂｶｴﾏｽ"))
```

### スレッド

x8ではLuaのスレッド（協調的マルチスレッド）のことを指し、一般的なOSのスレッドとは無関係です。各スレッドで`x8.wait()`を呼ぶことにより処理がシステムに戻り、次のスレッド処理やフレーム更新処理が行われます。

### オーディオハンドル

オーディオ関連の再生APIは、オーディオハンドルと呼ばれる再生処理単位のハンドルを返します。このハンドルを利用して各再生処理単位で停止させることが出来ます。

### オーディオチャンネル

x8は同時に最大4つのチャンネルから音を出すことが出来ます。システムはできるだけ多くの音が出るよう、自動でチャンネルを振り分けます。

---

## ビデオ関連

`x8.cls([col])`

- 色`col`で画面をクリアします。
- 描画パレットの影響を受けますが、描画オフセット、描画クリップ、抜き色情報の影響は受けません。
- 引き数のデフォルト値 : `col=0`

`x8.clip([x[,y[,w[,h]]]])`

- 描画クリップ矩形に、位置`x,y`とサイズ`w,h`を設定します。引き数なしで呼ぶとリセットします。
- 全ての描画命令は、この矩形の内側にだけ描画結果を反映します。
- 引き数のデフォルト値 : `x=0`,`y=0`,`w=128`,`h=128`

`x8.camera([x[,y]])`

- 描画座標オフセットに`x,y`を設定します。引き数なしで呼ぶとリセットします。
- 全ての描画命令は、位置をこのオフセット分ずらして描画します。
- 引き数のデフォルト値 : `x=0`,`y=0`

`x8.color([col])`

- デフォルト描画色に`col`を設定します。
- 色を指定可能な描画命令で、色を指定しなかった場合、この色で描画します。
- 引き数のデフォルト値 : `col=7`

`x8.drwpal([col0[,col1]])`

- 描画パレットに、色`col0`を`col1`に置き換わるよう設定します。引き数なしで呼ぶとリセットします。
- 全ての描画命令は、描画する色をこのパレットで置き換えます。
- 引き数のデフォルト値 : `col0=0`,`col1=col1`

`x8.scrpal([col0[,col1]])`

- 画面パレットに、色`col0`を`col1`に置き換わるよう設定します。引き数なしで呼ぶとリセットします。
- 描画結果の画面イメージは、最終的にこのパレットで色を置き換えて、表示されます。
- 引き数のデフォルト値 : `col0=0`,`col1=col1`

`x8.colorkey([col[,trs]])`

- 抜き色情報に、色`col`を抜きにするかどうかを`trs`(boolean)に設定します。引き数なしで呼ぶとリセットします。
- 全ての描画命令は、この情報で抜きになっている色を描画しません。
- 引き数のデフォルト値 : `col=0`,`trs=true`

`x8.spr(n,x,y[,w[,h,[,flpx[,flpy]]]])`

- `n`番のチップをを位置`x,y`に描画します。サイズ`w,h`はチップ単位です。`flipx`で左右の、 `flipy`で上下の反転を指定できます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `w=1`,`h=1`,`flipx=false`,`flipy=false`

`x8.gfx(gx,gy,gw,gh,x,y[,w[,h[,flpx[,flpy]]]])`

- Gfx内の位置`gx,gy`、サイズ`gw,gh`の矩形領域を、画面の位置`x,y`に描画します。`w,h`で描画サイズを指定できます。全てピクセル単位です。`flipx`で左右の、 `flipy`で上下の反転を指定できます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `w=gw`,`h=gh`,`flipx=false`,`flipy=false`

`x8.map(mapx,mapy,x,y[,mapw[,maph]])`

- Map内の位置`mapx,mapy`のチップを、画面の位置`x,y`に描画します。Map内のサイズを`mapw,maph`によりチップ単位で指定できます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `mapw=1`,`maph=1`

`x8.mapget(mapx,mapy)`

- Map内の位置`mapx,mapy`のチップ番号を取得して返します。

`x8.mapset(mapx,mapy,val)`

- Map内の位置`mapx,mapy`のチップ番号を`val`に設定します。

`x8.atrget(n[,bit])`

- `n`番のチップ属性を取得して返します。`bit`があればそのビット値をbooleanで、なければチップ属性値をそのまま返します。

`x8.atrset(n[,bit][,val])`

- `n`番のチップ属性を`val`に設定します。`bit`があれば`val`をbooleanとしてそのビット値を、なければ`val`をチップ属性値としてそのまま設定します。
- 引き数のデフォルト値 : `bit`がある場合`val=false`

`x8.scrget(x,y)`

- 画面の位置`x,y`のピクセルの色を取得して返します。

`x8.scrset(x,y,col)`

- 画面の位置`x,y`のピクセルに色`col`を設定します。
- 描画命令ではないため描画ステートの影響を受けません。

`x8.gfxget(gx,gy)`

- Gfx内の位置`x,y`のピクセルの色を取得して返します。

`x8.gfxset(gx,gy,col)`

- Gfx内の位置`x,y`のピクセルに色`col`を設定します。
- 描画命令ではないため描画ステートの影響を受けません。

`x8.pixel(x,y[,col])`

- 画面の位置`x,y`にピクセルを描画します。`col`で色を指定出来ます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `col=デフォルト描画色`

`x8.line(x0,y0,x1,y1[,col])`

- 画面に始点`x0,y0`終点`x1,y1`の直線を描画します。`col`で色を指定出来ます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `col=デフォルト描画色`

`x8.rectbdr(x0,y0,x1,y1[,col])`

- 画面に左上`x0,y0`右下`x1,y1`の矩形を描画します。`col`で色を指定出来ます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `col=デフォルト描画色`

`x8.rect(x0,y0,x1,y1[,col])`

- 画面に左上`x0,y0`右下`x1,y1`の塗りつぶされた矩形を描画します。`col`で色を指定出来ます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `col=デフォルト描画色`

`x8.circbdr(x,y,r[,col])`

- 画面に中心点`x,y`半径`r`の円を描画します。`col`で色を指定出来ます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `col=デフォルト描画色`

`x8.circ(x,y,r[,col])`

- 画面に中心点`x,y`半径`r`の塗りつぶされた円を描画します。`col`で色を指定出来ます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `col=デフォルト描画色`

---

## オーディオ関連

`x8.sfx(n[,spd[,pitch[,start[,len]]]])`

- `n`番のSfxを再生してオーディオハンドルを返します。`spd`は再生速度の倍率を実数で、`pitch`は音高のオフセット値を整数で、`start`は再生開始位置を整数で、`len`は再生ノート数を整数でそれぞれ指定出来ます。
- 引き数のデフォルト値 : `spd=1.0`,`pitch=0`,`start=0`,`len=最後まで`

`x8.hdlstop(hdl)`

- オーディオハンドル`hdl`で指定された再生中のサウンドを停止します。

`x8.sfxstop()`

- 再生中の全てのSfxを停止します。

---

## フォント関連

`x8.fnt(str,x,y[,col])`

- 文字列`str`を画面の位置`x,y`に描画します。`col`で色を指定出来ます。
- 描画ステートの影響を受けます。
- 引き数のデフォルト値 : `col=デフォルト描画色`

`x8.fntscale([sclx[,scly]])`

- フォント描画の際に反映されるスケール値を設定します。
- 引き数のデフォルト値 : `sclx=1.0`,`scly=1.0`

`x8.fntspace([spcx[,spcy]])`

- フォント描画の際に反映される文字間隔を設定します。
- 引き数のデフォルト値 : `spcx=0`,`spcy=0`

`x8.fntmeas(str) -> size_x,size_y`

- 描画ステートと各文字サイズを考慮して算出した、文字列`str`を描画した場合のサイズを、ピクセル単位の整数`w,h`として返します。

`x8.enc(str)`

- 文字列`str`に含まれるカタカナや特殊文字のコードを、全て8bitコードに変換して結果の文字列を返します。

---

## 入力関連

`x8.btnprs([bit])`

- 現フレームでの、ボタンの押下情報を返します。`bit`があればそのビット値をbooleanで、なければ全ボタン情報のビットマスクを整数で返します。

`x8.btntrg([bit])`

- 現フレームでの、ボタンのトリガー情報（OFFからONに変化したか）を返します。`bit`があればそのビット値をbooleanで、なければ全ボタン情報のビットマスクを整数で返します。

---

## その他

`x8.log(str)`

- 文字列`str`をログに出力します。

`x8.wait([frms])`

- この関数で`frms`回のフレームを待ちます。これを呼ぶことでシステムに処理が戻り、フレームが進行します。どのスレッドでも`1`以上の引き数でこれを呼ばないと、プログラムは一定時間後にタイムアウトエラーで停止します。
- 引き数のデフォルト値 : `frms=1`

`x8.clock()`

- プログラム実行を開始してからの経過時間を秒単位で返します。
